define(["handlebars","underscore","json2"],function(Handlebars,_,JSON){function precompile(string,_unused,options){var ast,environment;return options=options||{},"data"in options||(options.data=!0),options.compat&&(options.useDepths=!0),ast=Handlebars.parse(string),environment=(new Handlebars.Compiler).compile(ast,options),(new Handlebars.JavaScriptCompiler).compile(environment,options)}var fs,getXhr,progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],fetchText=function(){throw new Error("Environment unsupported.")},buildMap=[],filecode="w+",templateExtension="hbs",customNameExtension="@hbs",devStyleDirectory="/styles/",buildStyleDirectory="/demo-build/styles/",helperDirectory="templates/helpers/",buildCSSFileName="screen.build.css",onHbsReadMethod="onHbsRead";Handlebars.registerHelper("$",function(){}),"undefined"!=typeof window&&window.navigator&&window.document&&!window.navigator.userAgent.match(/Node.js/)?(getXhr=function(){var xhr,i,progId;if("undefined"!=typeof XMLHttpRequest)return arguments[0]===!0?new XDomainRequest:new XMLHttpRequest;for(i=0;3>i;i++){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}if(!xhr)throw new Error("getXhr(): XMLHttpRequest not available");return xhr},getIEVersion=function(){var rv=-1;if("Microsoft Internet Explorer"==navigator.appName){var ua=navigator.userAgent,re=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");null!=re.exec(ua)&&(rv=parseFloat(RegExp.$1))}return rv},fetchText=function(url,callback){var xdm=!1;if(0!=url.indexOf("http"))xdm=!1;else{var uidx="https"===url.substr(0,5)?8:7,hidx="https"===window.location.href.substr(0,5)?8:7,dom=url.substr(uidx).split("/").shift(),msie=getIEVersion();xdm=dom!=window.location.href.substr(hidx).split("/").shift()&&msie>=7}if(xdm){var xdr=getXhr(!0);xdr.open("GET",url),xdr.onload=function(){callback(xdr.responseText,url)},xdr.onprogress=function(){},xdr.ontimeout=function(){},xdr.onerror=function(){},setTimeout(function(){xdr.send()},0)}else{var xhr=getXhr();xhr.open("GET",url,!0),xhr.onreadystatechange=function(evt){4===xhr.readyState&&callback(xhr.responseText,url)},xhr.send(null)}}):"undefined"!=typeof process&&process.versions&&process.versions.node?(fs=require.nodeRequire("fs"),fetchText=function(path,callback){var body=fs.readFileSync(path,"utf8")||"";body=body.replace(/^\uFEFF/,""),callback(body,path)}):"undefined"!=typeof java&&"undefined"!=typeof java.io&&(fetchText=function(path,callback){for(var line,fis=new java.io.FileInputStream(path),streamReader=new java.io.InputStreamReader(fis,"UTF-8"),reader=new java.io.BufferedReader(streamReader),text="";null!==(line=reader.readLine());)text+=new String(line)+"\n";reader.close(),callback(text,path)});var config,styleList=[],styleMap={},filesToRemove=[];return{get:function(){return Handlebars},write:function(pluginName,name,write){if(name+customNameExtension in buildMap){var text=buildMap[name+customNameExtension];write.asModule(pluginName+"!"+name,text)}},version:"3.0.3",load:function(name,parentRequire,load,_config){function recursiveNodeSearch(statements,res){return _(statements).forEach(function(statement){statement&&statement.type&&"PartialStatement"===statement.type&&"SubExpression"!==statement.name.type&&res.push(statement.name.original),statement&&statement.program&&statement.program.body&&recursiveNodeSearch(statement.program.body,res),statement&&statement.inverse&&statement.inverse.body&&recursiveNodeSearch(statement.inverse.body,res)}),res}function findPartialDeps(nodes,metaObj){var res=[];return nodes&&nodes.body&&(res=recursiveNodeSearch(nodes.body,[])),metaObj&&metaObj.partials&&metaObj.partials.length&&_(metaObj.partials).forEach(function(partial){res.push(partial)}),_.unique(res)}function getMetaData(nodes){var statement,res,test;if(nodes&&nodes.body&&(statement=nodes.body[0],statement&&"CommentStatement"===statement.type))try{return res=statement.value.replace(new RegExp("^[\\s]+|[\\s]+$","g"),""),test=JSON.parse(res),res}catch(e){return JSON.stringify({description:res})}return"{}"}function isHelper(statement){return!!("SubExpression"===statement.type||statement.params&&statement.params.length||statement.hash)}function checkStatementForHelpers(statement,helpersres){isHelper(statement)&&"undefined"!=typeof statement.path&&registerHelper(statement.path.original,helpersres),statement&&statement.params&&statement.params.forEach(function(param){checkStatementForHelpers(param,helpersres)}),statement&&statement.hash&&statement.hash.pairs&&_(statement.hash.pairs).forEach(function(pair){checkStatementForHelpers(pair.value,helpersres)})}function registerHelper(helperName,helpersres){"undefined"==typeof Handlebars.helpers[helperName]&&helpersres.push(helperName)}function recursiveVarSearch(statements,res,prefix,helpersres){prefix=prefix?prefix+".":"";var newprefix="";return _(statements).forEach(function(statement){var sideways;(isHelper(statement)||"MustacheStatement"===statement.type)&&checkStatementForHelpers(statement,helpersres),statement&&statement.mustache&&recursiveVarSearch([statement.mustache],res,prefix+newprefix,helpersres),statement&&statement.program&&statement.program.body&&(sideways=recursiveVarSearch([statement.path],[],"",helpersres)[0]||"",statement.inverse&&statement.inverse.body&&recursiveVarSearch(statement.inverse.body,res,prefix+newprefix+(sideways?prefix+newprefix?"."+sideways:sideways:""),helpersres),recursiveVarSearch(statement.program.body,res,prefix+newprefix+(sideways?prefix+newprefix?"."+sideways:sideways:""),helpersres))}),res}function getExternalDeps(nodes){var res=[],helpersres=[];nodes&&nodes.body&&(res=recursiveVarSearch(nodes.body,[],void 0,helpersres));var defaultHelpers=["helperMissing","blockHelperMissing","each","if","unless","with","log","lookup"];return{vars:_(res).chain().unique().map(function(e){return""===e?".":e.length&&"."===e[e.length-1]?e.substr(0,e.length-1)+"[]":e}).value(),helpers:_(helpersres).chain().unique().map(function(e){return _(defaultHelpers).contains(e)?void 0:e}).compact().value()}}function cleanPath(path){for(var tokens=path.split("/"),i=0;i<tokens.length;i++)".."===tokens[i]?(delete tokens[i-1],delete tokens[i]):"."===tokens[i]&&delete tokens[i];return tokens.join("/").replace(/\/\/+/g,"/")}function fetchAndRegister(langMap){fetchText(path,function(text,path){var depStr,helpDepStr,metaObj,head,linkElem,readCallback=config.isBuild&&config[onHbsReadMethod]?config[onHbsReadMethod]:function(name,path,text){return text},nodes=Handlebars.parse(readCallback(name,path,text)),meta=getMetaData(nodes),extDeps=getExternalDeps(nodes),vars=extDeps.vars,helps=extDeps.helpers||[],debugOutputStart="",debugOutputEnd="",debugProperties="",deps=[],baseDir=name.substr(0,name.lastIndexOf("/")+1);if("{}"!==meta)try{metaObj=JSON.parse(meta)}catch(e){}var partials=findPartialDeps(nodes,metaObj);config.hbs=config.hbs||{},config.hbs._partials=config.hbs._partials||{};for(var i in partials)if(partials.hasOwnProperty(i)&&"string"==typeof partials[i]){var partialPath,partialReference=partials[i];if(partialPath=cleanPath(partialReference.match(/^(\.|\/)+/)?baseDir+partialReference:partialsUrl+partialReference),omitExtension){if(path===parentRequire.toUrl(partialPath))continue}else if(path===parentRequire.toUrl(partialPath+"."+(config.hbs&&config.hbs.templateExtension?config.hbs.templateExtension:templateExtension)))continue;config.hbs._partials[partialPath]=config.hbs._partials[partialPath]||[],config.hbs._partials[partialPath].references=config.hbs._partials[partialPath].references||[],config.hbs._partials[partialPath].references.push(partialReference),config.hbs._loadedDeps=config.hbs._loadedDeps||{},deps[i]="hbs!"+partialPath}if(depStr=deps.join("', '"),helps=helps.concat(metaObj&&metaObj.helpers?metaObj.helpers:[]),helpDepStr=disableHelpers?"":function(){var i,paths=[],pathGetter=config.hbs&&config.hbs.helperPathCallback?config.hbs.helperPathCallback:function(name){return(config.hbs&&config.hbs.helperDirectory?config.hbs.helperDirectory:helperDirectory)+name};for(i=0;i<helps.length;i++)paths[i]="'"+pathGetter(helps[i],path)+"'";return paths}().join(","),helpDepStr&&(helpDepStr=","+helpDepStr),metaObj)try{metaObj.styles&&(styleList=_.union(styleList,metaObj.styles),require.isBrowser&&!config.isBuild?(head=document.head||document.getElementsByTagName("head")[0],_(metaObj.styles).forEach(function(style){styleMap[style]||(linkElem=document.createElement("link"),linkElem.href=config.baseUrl+devStyleDirectory+style+".css",linkElem.media="all",linkElem.rel="stylesheet",linkElem.type="text/css",head.appendChild(linkElem),styleMap[style]=linkElem)})):config.isBuild&&!function(){var fs=require.nodeRequire("fs"),str=_(metaObj.styles).map(function(style){return styleMap[style]?"":(styleMap[style]=!0,"@import url("+style+".css);\n")}).join("\n");fs.open(__dirname+buildStyleDirectory+buildCSSFileName,filecode,"0666",function(e,id){fs.writeSync(id,str,null,encoding="utf8"),fs.close(id)}),filecode="a"}())}catch(e){}config.isBuild||config.serverRender||(debugOutputStart="<!-- START - "+name+" -->",debugOutputEnd="<!-- END - "+name+" -->",debugProperties="t.meta = "+meta+";\nt.helpers = "+JSON.stringify(helps)+";\nt.deps = "+JSON.stringify(deps)+";\nt.vars = "+JSON.stringify(vars)+";\n");var mapping=!1,configHbs=config.hbs||{},options=_.extend(configHbs.compileOptions||{},{originalKeyFallback:configHbs.originalKeyFallback}),prec=precompile(text,mapping,options),tmplName="'hbs!"+name+"',";depStr&&(depStr=", '"+depStr+"'");var partialReferences=[];config.hbs._partials[name]&&(partialReferences=config.hbs._partials[name].references);var handlebarsPath=config.hbs&&config.hbs.handlebarsPath?config.hbs.handlebarsPath:"hbs/handlebars";text="/* START_TEMPLATE */\ndefine("+tmplName+"['"+handlebarsPath+"'"+depStr+helpDepStr+"], function( Handlebars ){ \nvar t = Handlebars.template("+prec+");\nHandlebars.registerPartial('"+name+"', t);\n";for(var i=0;i<partialReferences.length;i++)text+="Handlebars.registerPartial('"+partialReferences[i]+"', t);\n";text+=debugProperties+"return t;\n});\n/* END_TEMPLATE */\n",config.isBuild&&(buildMap[compiledName]=text),config.isBuild||(text+="\r\n//# sourceURL="+path),config.isBuild?(load.fromText(name,text),parentRequire([name],function(value){load(value)})):parentRequire(deps,function(){load.fromText(text),parentRequire([name],function(value){load(value)})}),config.removeCombined&&path&&filesToRemove.push(path)})}config=config||_config;var compiledName=name+customNameExtension;config.hbs=config.hbs||{};var disableHelpers=0==config.hbs.helpers,partialsUrl="";config.hbs.partialsUrl&&(partialsUrl=config.hbs.partialsUrl,partialsUrl.match(/\/$/)||(partialsUrl+="/")),config.hbs.fetchText&&(fetchText=config.hbs.fetchText);var path,omitExtension=config.hbs&&config.hbs.templateExtension===!1;path=omitExtension?parentRequire.toUrl(name):parentRequire.toUrl(name+"."+(config.hbs&&config.hbs.templateExtension?config.hbs.templateExtension:templateExtension)),fetchAndRegister(!1)},onLayerEnd:function(){config.removeCombined&&fs&&filesToRemove.forEach(function(path){fs.existsSync(path)&&fs.unlinkSync(path)})}}});